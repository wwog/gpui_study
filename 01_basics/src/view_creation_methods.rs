// ç¬¬ä¸€ç« ï¼šGPUI åŸºç¡€æ¦‚å¿µ
// æ–‡ä»¶ï¼šview_creation_methods.rs - æ¼”ç¤ºåˆ›å»ºå­è§†å›¾çš„æ‰€æœ‰æ–¹å¼

use gpui::*;

// ============================================================================
// æ–¹å¼ 1: ä½¿ç”¨ cx.new() åˆ›å»º View<T> (æœ€å¸¸ç”¨) â­â­â­â­â­
// ============================================================================
//
// ç‰¹ç‚¹ï¼š
// - åˆ›å»ºæœ‰çŠ¶æ€çš„è§†å›¾ç»„ä»¶
// - æ¯ä¸ªå®ä¾‹ç‹¬ç«‹ç®¡ç†çŠ¶æ€
// - å¯ä»¥é€šè¿‡ cx.notify() è§¦å‘é‡æ–°æ¸²æŸ“
// - ç”Ÿå‘½å‘¨æœŸç”± GPUI ç®¡ç†
//
// é€‚ç”¨åœºæ™¯ï¼š
// - éœ€è¦ç‹¬ç«‹çŠ¶æ€çš„ç»„ä»¶
// - å¯å¤ç”¨çš„ UI ç»„ä»¶
// - å¤æ‚çš„äº¤äº’ç»„ä»¶

struct StatefulComponent {
    title: String,
    count: i32,
}

impl Render for StatefulComponent {
    fn render(&mut self, _window: &mut Window, _cx: &mut Context<Self>) -> impl IntoElement {
        div()
            .p_4()
            .bg(rgb(0xE0F2FE))
            .rounded_lg()
            .child(format!("{}: {}", self.title, self.count))
    }
}

// ============================================================================
// æ–¹å¼ 2: ç›´æ¥ä½¿ç”¨ div() å’ŒåŸºç¡€å…ƒç´  (å†…è”æ¸²æŸ“) â­â­â­â­
// ============================================================================
//
// ç‰¹ç‚¹ï¼š
// - ä¸éœ€è¦å®šä¹‰ç»“æ„ä½“
// - é€‚åˆç®€å•ã€ä¸€æ¬¡æ€§çš„ UI
// - æ— æ³•ç‹¬ç«‹ç®¡ç†çŠ¶æ€
// - ä»£ç ç›´è§‚
//
// é€‚ç”¨åœºæ™¯ï¼š
// - ç®€å•çš„å¸ƒå±€å®¹å™¨
// - é™æ€å†…å®¹
// - åŸå‹å¼€å‘

fn inline_div_example() -> Div {
    div()
        .p_4()
        .bg(rgb(0xFEE2E2))
        .rounded_lg()
        .child("è¿™æ˜¯å†…è” divï¼Œæ— éœ€é¢å¤–ç»“æ„ä½“")
}

// ============================================================================
// æ–¹å¼ 3: å®ç° RenderOnce trait (ä¸€æ¬¡æ€§æ¸²æŸ“) â­â­â­â­
// ============================================================================
//
// ç‰¹ç‚¹ï¼š
// - æ¶ˆè€—è‡ªèº« (self)ï¼Œä¸æ˜¯ &mut self
// - é€‚åˆæ— çŠ¶æ€ã€ä¸€æ¬¡æ€§çš„ç»„ä»¶
// - æ€§èƒ½æ›´å¥½ï¼ˆä¸éœ€è¦ä¿ç•™çŠ¶æ€ï¼‰
// - ç±»ä¼¼ React çš„å‡½æ•°ç»„ä»¶
//
// é€‚ç”¨åœºæ™¯ï¼š
// - æ— çŠ¶æ€ç»„ä»¶
// - çº¯å±•ç¤ºå‹ç»„ä»¶
// - ä¸éœ€è¦æ›´æ–°çš„ç»„ä»¶

struct OnceComponent {
    message: String,
    color: Hsla,
}

impl RenderOnce for OnceComponent {
    fn render(self, _window: &mut Window, _cx: &mut App) -> impl IntoElement {
        div().p_4().bg(self.color).rounded_lg().child(self.message)
    }
}

// ============================================================================
// æ–¹å¼ 4: ä½¿ç”¨é—­åŒ…/å‡½æ•°è¿”å›å…ƒç´  â­â­â­
// ============================================================================
//
// ç‰¹ç‚¹ï¼š
// - å‡½æ•°å¼ç¼–ç¨‹é£æ ¼
// - æ˜“äºç»„åˆå’Œå¤ç”¨
// - å¯ä»¥æ¥å—å‚æ•°
// - ä»£ç ç®€æ´
//
// é€‚ç”¨åœºæ™¯ï¼š
// - å¯å¤ç”¨çš„ UI ç‰‡æ®µ
// - éœ€è¦å‚æ•°åŒ–çš„ç»„ä»¶
// - å·¥å…·å‡½æ•°

fn create_label(text: String, color: Hsla) -> impl IntoElement {
    div()
        .px_3()
        .py_1()
        .bg(color)
        .rounded_md()
        .text_sm()
        .child(text)
}

fn create_card(title: String, content: String) -> impl IntoElement {
    div()
        .flex()
        .flex_col()
        .gap_2()
        .p_4()
        .bg(rgb(0xFFFFFF))
        .rounded_lg()
        .shadow_md()
        .child(div().font_weight(FontWeight::BOLD).child(title))
        .child(div().text_sm().text_color(rgb(0x6B7280)).child(content))
}

// ============================================================================
// æ–¹å¼ 5: ä½¿ç”¨å­—ç¬¦ä¸²å’ŒåŸºæœ¬ç±»å‹ (è‡ªåŠ¨è½¬æ¢) â­â­â­â­â­
// ============================================================================
//
// ç‰¹ç‚¹ï¼š
// - æœ€ç®€å•çš„æ–¹å¼
// - è‡ªåŠ¨å®ç° IntoElement
// - é€‚åˆçº¯æ–‡æœ¬å†…å®¹
//
// æ”¯æŒçš„ç±»å‹ï¼š
// - &str
// - String
// - æ•°å­—ç±»å‹ (é€šè¿‡ .to_string())
// - å®ç°äº† Display çš„ç±»å‹

// ä¾‹å¦‚ï¼š
// .child("Hello")                    // &str
// .child(String::from("World"))      // String
// .child(format!("Count: {}", 42))   // æ ¼å¼åŒ–å­—ç¬¦ä¸²

// ============================================================================
// æ–¹å¼ 6: ä½¿ç”¨ Option<T> (æ¡ä»¶æ¸²æŸ“) â­â­â­â­
// ============================================================================
//
// ç‰¹ç‚¹ï¼š
// - æ¡ä»¶æ€§åœ°æ˜¾ç¤º/éšè—ç»„ä»¶
// - Some(element) æ˜¾ç¤ºï¼ŒNone ä¸æ˜¾ç¤º
// - ç±»ä¼¼ React çš„æ¡ä»¶æ¸²æŸ“
//
// é€‚ç”¨åœºæ™¯ï¼š
// - æ ¹æ®çŠ¶æ€æ˜¾ç¤ºä¸åŒå†…å®¹
// - å¯é€‰çš„ UI å…ƒç´ 

fn conditional_child(show: bool) -> Div {
    if show {
        div().child("æ˜¾ç¤ºçš„å†…å®¹")
    } else {
        div().child("éšè—çŠ¶æ€")
    }
}

// ============================================================================
// æ–¹å¼ 7: ä½¿ç”¨è¿­ä»£å™¨å’Œ .children() (æ‰¹é‡æ·»åŠ ) â­â­â­â­â­
// ============================================================================
//
// ç‰¹ç‚¹ï¼š
// - æ‰¹é‡æ·»åŠ å¤šä¸ªå­å…ƒç´ 
// - æ¥å—ä»»ä½•è¿­ä»£å™¨
// - é€‚åˆåˆ—è¡¨æ•°æ®
// - å¯ä»¥ä½¿ç”¨ mapã€filter ç­‰æ“ä½œ
//
// é€‚ç”¨åœºæ™¯ï¼š
// - åˆ—è¡¨æ¸²æŸ“
// - åŠ¨æ€æ•°é‡çš„å…ƒç´ 
// - æ•°æ®é©±åŠ¨çš„ UI

fn list_from_data(items: &[String]) -> impl IntoElement {
    div()
        .flex()
        .flex_col()
        .gap_2()
        .children(items.iter().map(|item| {
            div()
                .p_2()
                .bg(rgb(0xF3F4F6))
                .rounded_md()
                .child(item.clone())
        }))
}

// ============================================================================
// æ–¹å¼ 8: åµŒå¥— View ç»„åˆ â­â­â­â­
// ============================================================================
//
// ç‰¹ç‚¹ï¼š
// - View ä¸­åŒ…å«å…¶ä»– View
// - æ„å»ºå¤æ‚çš„ç»„ä»¶æ ‘
// - ç»„ä»¶ä¹‹é—´å¯ä»¥é€šä¿¡ï¼ˆé€šè¿‡ Modelï¼‰
//
// é€‚ç”¨åœºæ™¯ï¼š
// - å¤æ‚çš„åº”ç”¨ç»“æ„
// - ç»„ä»¶éœ€è¦ç›¸äº’é€šä¿¡

struct ParentView {
    title: String,
}

impl Render for ParentView {
    fn render(&mut self, _window: &mut Window, cx: &mut Context<Self>) -> impl IntoElement {
        div()
            .flex()
            .flex_col()
            .gap_4()
            .child(self.title.clone())
            // åµŒå¥—å…¶ä»– View
            .child(cx.new(|_| StatefulComponent {
                title: "å­ç»„ä»¶ 1".to_string(),
                count: 10,
            }))
            .child(cx.new(|_| StatefulComponent {
                title: "å­ç»„ä»¶ 2".to_string(),
                count: 20,
            }))
    }
}

// ============================================================================
// å®Œæ•´ç¤ºä¾‹ï¼šç»„åˆæ‰€æœ‰æ–¹å¼
// ============================================================================

struct AllMethodsDemo {
    show_optional: bool,
    items: Vec<String>,
}

impl Render for AllMethodsDemo {
    fn render(&mut self, _window: &mut Window, cx: &mut Context<Self>) -> impl IntoElement {
        div()
            .size_full()
            .flex()
            .flex_col()
            .gap_4()
            .p_8()
            .bg(rgb(0xF9FAFB))
            // æ ‡é¢˜
            .child(
                div()
                    .text_2xl()
                    .font_weight(FontWeight::BOLD)
                    .child("æ‰€æœ‰åˆ›å»ºå­è§†å›¾çš„æ–¹å¼"),
            )
            // æ–¹å¼ 1: cx.new() åˆ›å»º View
            .child(
                div()
                    .flex()
                    .flex_col()
                    .gap_2()
                    .child("ã€æ–¹å¼ 1ã€‘ä½¿ç”¨ cx.new() åˆ›å»º Viewï¼š")
                    .child(cx.new(|_| StatefulComponent {
                        title: "æœ‰çŠ¶æ€ç»„ä»¶".to_string(),
                        count: 42,
                    })),
            )
            // æ–¹å¼ 2: å†…è” div
            .child(
                div()
                    .flex()
                    .flex_col()
                    .gap_2()
                    .child("ã€æ–¹å¼ 2ã€‘å†…è” div()ï¼š")
                    .child(inline_div_example()),
            )
            // æ–¹å¼ 3: RenderOnce
            .child(
                div()
                    .flex()
                    .flex_col()
                    .gap_2()
                    .child("ã€æ–¹å¼ 3ã€‘RenderOnce traitï¼š")
                    .child(
                        div()
                            .p_4()
                            .bg(rgb(0xFEF3C7))
                            .rounded_lg()
                            .child("ä¸€æ¬¡æ€§æ¸²æŸ“ç»„ä»¶ï¼ˆç®€åŒ–ç‰ˆï¼‰"),
                    ),
            )
            // æ–¹å¼ 4: å‡½æ•°è¿”å›å…ƒç´ 
            .child(
                div()
                    .flex()
                    .flex_col()
                    .gap_2()
                    .child("ã€æ–¹å¼ 4ã€‘å‡½æ•°è¿”å›å…ƒç´ ï¼š")
                    .child(create_card(
                        "å¡ç‰‡æ ‡é¢˜".to_string(),
                        "è¿™æ˜¯é€šè¿‡å‡½æ•°åˆ›å»ºçš„å¡ç‰‡ç»„ä»¶".to_string(),
                    ))
                    .child(
                        div()
                            .flex()
                            .gap_2()
                            .child(create_label("æ ‡ç­¾ 1".to_string(), rgb(0xDCFCE7).into()))
                            .child(create_label("æ ‡ç­¾ 2".to_string(), rgb(0xFEE2E2).into()))
                            .child(create_label("æ ‡ç­¾ 3".to_string(), rgb(0xDDD6FE).into())),
                    ),
            )
            // æ–¹å¼ 5: å­—ç¬¦ä¸²å’ŒåŸºæœ¬ç±»å‹
            .child(
                div()
                    .flex()
                    .flex_col()
                    .gap_2()
                    .child("ã€æ–¹å¼ 5ã€‘å­—ç¬¦ä¸²å’ŒåŸºæœ¬ç±»å‹ï¼š")
                    .child(
                        div()
                            .flex()
                            .gap_4()
                            .child("çº¯æ–‡æœ¬")
                            .child(String::from("String ç±»å‹"))
                            .child(format!("æ•°å­—: {}", 123)),
                    ),
            )
            // æ–¹å¼ 6: Option æ¡ä»¶æ¸²æŸ“
            .child(
                div()
                    .flex()
                    .flex_col()
                    .gap_2()
                    .child("ã€æ–¹å¼ 6ã€‘æ¡ä»¶æ¸²æŸ“ï¼š")
                    .child(conditional_child(self.show_optional))
                    .child(if self.show_optional {
                        div()
                            .p_2()
                            .bg(rgb(0xD1FAE5))
                            .rounded_md()
                            .child("âœ“ æ¡ä»¶ä¸ºçœŸï¼Œæ˜¾ç¤ºæ­¤å†…å®¹")
                    } else {
                        div()
                            .p_2()
                            .bg(rgb(0xFEE2E2))
                            .rounded_md()
                            .child("âœ— æ¡ä»¶ä¸ºå‡ï¼Œæ˜¾ç¤ºå¦ä¸€å†…å®¹")
                    }),
            )
            // æ–¹å¼ 7: è¿­ä»£å™¨å’Œ .children()
            .child(
                div()
                    .flex()
                    .flex_col()
                    .gap_2()
                    .child("ã€æ–¹å¼ 7ã€‘è¿­ä»£å™¨å’Œ .children()ï¼š")
                    .child(list_from_data(&self.items)),
            )
            // æ–¹å¼ 8: åµŒå¥— View
            .child(
                div()
                    .flex()
                    .flex_col()
                    .gap_2()
                    .child("ã€æ–¹å¼ 8ã€‘åµŒå¥— View ç»„åˆï¼š")
                    .child(cx.new(|_| ParentView {
                        title: "çˆ¶ç»„ä»¶åŒ…å«å­ç»„ä»¶".to_string(),
                    })),
            )
    }
}

// ============================================================================
// ä¸»å‡½æ•°
// ============================================================================

pub fn main() {
    Application::new().run(|cx| {
        cx.open_window(
            WindowOptions {
                window_bounds: Some(WindowBounds::Windowed(Bounds {
                    origin: Point {
                        x: px(100.0),
                        y: px(100.0),
                    },
                    size: Size {
                        width: px(800.0),
                        height: px(900.0),
                    },
                })),
                titlebar: Some(TitlebarOptions {
                    title: Some("æ‰€æœ‰åˆ›å»ºå­è§†å›¾çš„æ–¹å¼".into()),
                    appears_transparent: false,
                    ..Default::default()
                }),
                ..Default::default()
            },
            |_window, cx| {
                cx.new(|_cx| AllMethodsDemo {
                    show_optional: true,
                    items: vec![
                        "åˆ—è¡¨é¡¹ 1".to_string(),
                        "åˆ—è¡¨é¡¹ 2".to_string(),
                        "åˆ—è¡¨é¡¹ 3".to_string(),
                    ],
                })
            },
        )
        .unwrap();
    });
}

/*
===============================================================================
ğŸ“š æ€»ç»“ï¼šåˆ›å»ºå­è§†å›¾çš„æ–¹å¼å¯¹æ¯”è¡¨
===============================================================================

| æ–¹å¼ | è¯­æ³• | æœ‰çŠ¶æ€ | å¤ç”¨æ€§ | æ€§èƒ½ | æ¨èåº¦ |
|------|------|--------|--------|------|--------|
| 1. cx.new() | cx.new(\|_\| View{}) | âœ… | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ |
| 2. å†…è” div | div().child() | âŒ | â­ | â­â­â­â­â­ | â­â­â­ |
| 3. RenderOnce | struct + RenderOnce | âŒ | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ |
| 4. å‡½æ•° | fn() -> Element | âŒ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­ |
| 5. å­—ç¬¦ä¸² | .child("text") | âŒ | â­ | â­â­â­â­â­ | â­â­â­â­â­ |
| 6. Option | Some(element) | - | â­â­â­ | â­â­â­â­ | â­â­â­â­ |
| 7. .children() | .children(iter) | - | â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ |
| 8. åµŒå¥— View | View { child: View } | âœ… | â­â­â­â­â­ | â­â­â­ | â­â­â­â­ |

===============================================================================
ğŸ¯ é€‰æ‹©å»ºè®®
===============================================================================

éœ€è¦ç‹¬ç«‹çŠ¶æ€ï¼Ÿ        â†’ ä½¿ç”¨ cx.new() åˆ›å»º View
çº¯å±•ç¤ºã€æ— çŠ¶æ€ï¼Ÿ      â†’ ä½¿ç”¨ RenderOnce
ç®€å•æ–‡æœ¬ï¼Ÿ            â†’ ç›´æ¥ç”¨å­—ç¬¦ä¸²
å¯å¤ç”¨çš„ UI ç‰‡æ®µï¼Ÿ    â†’ åˆ›å»ºå‡½æ•°è¿”å›å…ƒç´ 
åˆ—è¡¨æ•°æ®ï¼Ÿ            â†’ ä½¿ç”¨ .children() + è¿­ä»£å™¨
æ¡ä»¶æ˜¾ç¤ºï¼Ÿ            â†’ ä½¿ç”¨ Option<Element>
å¿«é€ŸåŸå‹ï¼Ÿ            â†’ å†…è” div()
å¤æ‚åº”ç”¨ï¼Ÿ            â†’ ç»„åˆå¤šç§æ–¹å¼

===============================================================================
ğŸ’¡ æ ¸å¿ƒåŸåˆ™
===============================================================================

1. IntoElement trait æ˜¯å…³é”®
   - ä»»ä½•å®ç°äº† IntoElement çš„ç±»å‹éƒ½å¯ä»¥ä½œä¸ºå­å…ƒç´ 
   - åŒ…æ‹¬ï¼šView<T>ã€Divã€Stringã€&strã€RenderOnce ç­‰

2. é€‰æ‹©åˆé€‚çš„æ–¹å¼
   - æœ‰çŠ¶æ€ â†’ View (cx.new)
   - æ— çŠ¶æ€ â†’ RenderOnce æˆ–å‡½æ•°
   - ç®€å•å†…å®¹ â†’ å†…è”æˆ–å­—ç¬¦ä¸²

3. ç»„åˆä½¿ç”¨
   - å®é™…é¡¹ç›®ä¸­é€šå¸¸ä¼šæ··åˆä½¿ç”¨å¤šç§æ–¹å¼
   - æ ¹æ®å…·ä½“åœºæ™¯é€‰æ‹©æœ€åˆé€‚çš„æ–¹æ³•

===============================================================================
è¿è¡Œæœ¬ç¤ºä¾‹ï¼š
cargo run --bin view_creation_methods
===============================================================================
*/
